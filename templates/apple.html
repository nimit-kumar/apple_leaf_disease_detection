<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçé Apple Leaf Disease Detection - AI-Powered Diagnosis</title>
    <style>
        :root {
            --primary: #2E7D32;
            --primary-dark: #1B5E20;
            --primary-light: #4CAF50;
            --secondary: #1976D2;
            --danger: #D32F2F;
            --warning: #F57C00;
            --info: #0288D1;
            --dark: #212121;
            --light: #F5F5F5;
            --gray: #757575;
            --success: #388E3C;
            --card-bg: #FFFFFF;
            --header-bg: linear-gradient(135deg, #1B5E20 0%, #2E7D32 100%);
            --footer-bg: #1B5E20;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Poppins', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        header {
            background: var(--header-bg);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            border-bottom: 5px solid var(--primary-dark);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            font-size: 2.5rem;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
            color: #FFD700;
        }
        
        .header-text h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            color: white;
        }
        
        .header-text p {
            font-size: 1.1rem;
            opacity: 0.9;
            color: #E0E0E0;
        }
        
        .stats-banner {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .stat-item {
            text-align: center;
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            min-width: 120px;
            transition: transform 0.3s, background 0.3s;
        }
        
        .stat-item:hover {
            transform: translateY(-3px);
            background: rgba(255,255,255,0.2);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tabs-container {
            background: var(--light);
            padding: 0 20px;
            border-bottom: 2px solid var(--primary-light);
        }
        
        .tabs {
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            gap: 5px;
        }
        
        .tabs::-webkit-scrollbar {
            display: none;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--gray);
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab:hover {
            color: var(--primary);
            background: rgba(76, 175, 80, 0.1);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: rgba(76, 175, 80, 0.1);
        }
        
        .main-content {
            padding: 30px;
            min-height: 600px;
            background: #FAFAFA;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .detection-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 1024px) {
            .detection-layout {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border: 1px solid #E0E0E0;
            height: 100%;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
        }
        
        .card-title {
            font-size: 1.4rem;
            color: var(--primary-dark);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--primary);
        }
        
        .upload-zone {
            border: 3px dashed #BDBDBD;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #F5F5F5;
            margin-bottom: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .upload-zone:hover, .upload-zone.drag-over {
            border-color: var(--primary);
            background: #E8F5E9;
            transform: translateY(-2px);
        }
        
        .upload-icon {
            font-size: 60px;
            color: var(--primary);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .upload-zone:hover .upload-icon {
            transform: scale(1.1);
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
            text-decoration: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 125, 50, 0.3);
            background: var(--primary-dark);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #BDBDBD;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: var(--secondary);
        }
        
        .btn-secondary:hover {
            background: #1565C0;
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.3);
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-warning:hover {
            background: #EF6C00;
            box-shadow: 0 6px 20px rgba(245, 124, 0, 0.3);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #C62828;
            box-shadow: 0 6px 20px rgba(211, 47, 47, 0.3);
        }
        
        .btn-info {
            background: var(--info);
        }
        
        .btn-info:hover {
            background: #0277BD;
            box-shadow: 0 6px 20px rgba(2, 136, 209, 0.3);
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            object-fit: contain;
            border: 2px solid var(--primary-light);
        }
        
        .results-container {
            flex: 1;
            overflow-y: auto;
        }
        
        .disease-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            animation: slideIn 0.5s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .disease-name {
            font-size: 1.6rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .confidence-meter {
            background: rgba(255,255,255,0.2);
            height: 24px;
            border-radius: 12px;
            margin: 20px 0;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A, #CDDC39);
            border-radius: 12px;
            transition: width 1s ease;
            position: relative;
            overflow: hidden;
        }
        
        .confidence-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.2) 25%, 
                rgba(255,255,255,0) 25%, 
                rgba(255,255,255,0) 50%, 
                rgba(255,255,255,0.2) 50%, 
                rgba(255,255,255,0.2) 75%, 
                rgba(255,255,255,0) 75%);
            background-size: 50px 100%;
            animation: shimmer 2s infinite linear;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .severity-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 5px 0;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .severity-high { background: #FF5252; }
        .severity-medium { background: #FFB74D; color: #333; }
        .severity-low { background: #4CAF50; }
        .severity-none { background: #66BB6A; }
        
        .info-box {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .treatment-tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 5px;
            margin-bottom: 20px;
            gap: 5px;
        }
        
        .treatment-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            font-weight: 600;
            background: rgba(255,255,255,0.05);
        }
        
        .treatment-tab:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .treatment-tab.active {
            background: rgba(255,255,255,0.3);
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .treatment-content {
            display: none;
        }
        
        .treatment-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 1.1rem;
        }
        
        .treatment-item {
            margin-left: 20px;
            margin-bottom: 8px;
            position: relative;
            padding-left: 10px;
        }
        
        .treatment-item::before {
            content: "‚Ä¢";
            position: absolute;
            left: -15px;
            color: #FFD700;
            font-size: 1.2rem;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        footer {
            text-align: center;
            padding: 30px;
            background: var(--footer-bg);
            color: white;
            margin-top: 30px;
            border-top: 5px solid var(--primary-dark);
        }
        
        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .footer-stats {
            display: flex;
            gap: 30px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .camera-section {
            margin-top: 20px;
            text-align: center;
        }
        
        #cameraPreview {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            border: 3px solid var(--primary);
            display: none;
            background: #000;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .history-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .history-item {
            background: #F5F5F5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #E0E0E0;
        }
        
        .history-item:hover {
            background: #E8F5E9;
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .diseases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .disease-item {
            background: #F5F5F5;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            border: 1px solid #E0E0E0;
        }
        
        .disease-item:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            background: white;
        }
        
        .disease-icon {
            font-size: 40px;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
            border: 1px solid #A5D6A7;
        }
        
        .stat-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .report-content {
            background: #F5F5F5;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #E0E0E0;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            max-width: 400px;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification.success {
            background: rgba(76, 175, 80, 0.9);
        }
        
        .notification.error {
            background: rgba(211, 47, 47, 0.9);
        }
        
        .notification.info {
            background: rgba(2, 136, 209, 0.9);
        }
        
        .notification.warning {
            background: rgba(245, 124, 0, 0.9);
        }
        
        .progress-bar {
            width: 100%;
            height: 5px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
                gap: 20px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .stats-banner {
                gap: 10px;
            }
            
            .stat-item {
                min-width: 100px;
                padding: 8px 15px;
            }
            
            .tab {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .footer-content {
                flex-direction: column;
                text-align: center;
            }
            
            .footer-stats {
                justify-content: center;
            }
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Notifications Container -->
    <div id="notifications"></div>
    
    <!-- Modal for detailed view -->
    <div class="modal" id="diseaseModal">
        <div class="modal-content">
            <div id="modalContent"></div>
            <button class="btn btn-danger" onclick="closeModal()" style="margin-top: 20px; width: 100%;">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>
    
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-apple-alt logo-icon"></i>
                    <div class="header-text">
                        <h1>Apple Leaf Disease Detection</h1>
                        <p>AI-powered diagnosis with prevention & cure recommendations</p>
                    </div>
                </div>
                <div class="stats-banner">
                    <div class="stat-item">
                        <div class="stat-value" id="totalDiseases">9</div>
                        <div class="stat-label">Diseases</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="modelAccuracy">97.7%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="detections">0</div>
                        <div class="stat-label">Detections</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="systemStatus" style="color: #4CAF50;">Online</div>
                        <div class="stat-label">Status</div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('detection')">
                    <i class="fas fa-search"></i> Detection
                </button>
                <button class="tab" onclick="switchTab('camera')">
                    <i class="fas fa-camera"></i> Camera
                </button>
                <button class="tab" onclick="switchTab('history')">
                    <i class="fas fa-history"></i> History
                </button>
                <button class="tab" onclick="switchTab('diseases')">
                    <i class="fas fa-bug"></i> Diseases
                </button>
                <button class="tab" onclick="switchTab('prevention')">
                    <i class="fas fa-shield-alt"></i> Prevention
                </button>
                <button class="tab" onclick="switchTab('reports')">
                    <i class="fas fa-file-medical"></i> Reports
                </button>
                <button class="tab" onclick="switchTab('stats')">
                    <i class="fas fa-chart-bar"></i> Statistics
                </button>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Detection Tab -->
            <div id="detection-tab" class="tab-content active">
                <div class="detection-layout">
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-upload"></i> Upload Leaf Image</h2>
                        <div class="upload-zone" id="uploadZone">
                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                            <h3>Drag & Drop Image Here</h3>
                            <p>or click to browse files</p>
                            <div class="action-buttons" style="margin-top: 20px;">
                                <button class="btn" onclick="document.getElementById('fileInput').click()">
                                    <i class="fas fa-folder-open"></i> Browse Files
                                </button>
                                <button class="btn btn-secondary" onclick="switchTab('camera')">
                                    <i class="fas fa-camera"></i> Use Camera
                                </button>
                            </div>
                            <p style="margin-top: 15px; color: #666; font-size: 0.9rem;">
                                <i class="fas fa-info-circle"></i> Supported formats: JPG, PNG, WEBP (Max: 16MB)
                            </p>
                        </div>
                        <input type="file" id="fileInput" accept="image/*">
                        
                        <div id="previewContainer" class="hidden">
                            <img id="imagePreview" class="image-preview" src="" alt="Preview">
                            <div class="action-buttons">
                                <button class="btn" onclick="detectDisease()" id="detectBtn">
                                    <i class="fas fa-search"></i> Detect Disease
                                </button>
                                <button class="btn btn-warning" onclick="clearImage()">
                                    <i class="fas fa-redo"></i> Clear
                                </button>
                                <button class="btn btn-info" onclick="enhanceImage()">
                                    <i class="fas fa-magic"></i> Enhance
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-chart-line"></i> Detection Results</h2>
                        <div id="resultsContent" class="results-container">
                            <div class="loading">
                                <div class="spinner"></div>
                                <h3>Ready for Detection</h3>
                                <p>Upload an image to start analysis</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Camera Tab -->
            <div id="camera-tab" class="tab-content">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-camera"></i> Live Camera Capture</h2>
                    <div class="camera-section">
                        <video id="cameraPreview" autoplay playsinline></video>
                        <div class="camera-controls">
                            <button class="btn" onclick="startCamera()" id="startCameraBtn">
                                <i class="fas fa-play"></i> Start Camera
                            </button>
                            <button class="btn btn-secondary" onclick="capturePhoto()" id="captureBtn" disabled>
                                <i class="fas fa-camera"></i> Capture
                            </button>
                            <button class="btn btn-warning" onclick="switchCamera()" id="switchCameraBtn" disabled>
                                <i class="fas fa-sync-alt"></i> Switch Camera
                            </button>
                            <button class="btn btn-danger" onclick="stopCamera()" id="stopCameraBtn" disabled>
                                <i class="fas fa-stop"></i> Stop Camera
                            </button>
                        </div>
                        
                        <div id="capturePreviewContainer" class="hidden" style="margin-top: 20px;">
                            <img id="capturePreview" class="image-preview" src="" alt="Capture Preview">
                            <div class="action-buttons">
                                <button class="btn" onclick="useCapturedPhoto()">
                                    <i class="fas fa-check"></i> Use This Photo
                                </button>
                                <button class="btn btn-warning" onclick="retakePhoto()">
                                    <i class="fas fa-redo"></i> Retake
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- History Tab -->
            <div id="history-tab" class="tab-content">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-history"></i> Detection History</h2>
                    <div class="action-buttons">
                        <button class="btn" onclick="loadHistory()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                        <button class="btn btn-secondary" onclick="exportHistory()">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                        <button class="btn btn-danger" onclick="clearHistory()">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                    
                    <div class="history-list" id="historyList">
                        <p style="text-align: center; padding: 40px; color: #666;">
                            No detection history yet
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Diseases Tab -->
            <div id="diseases-tab" class="tab-content">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-bug"></i> Diseases Database</h2>
                    <div class="action-buttons">
                        <button class="btn" onclick="loadDiseasesFromAPI()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                        <button class="btn btn-secondary" onclick="showAllDiseases()">
                            <i class="fas fa-list"></i> View All
                        </button>
                        <button class="btn btn-info" onclick="showHealthyInfo()">
                            <i class="fas fa-heart"></i> Healthy Leaf Info
                        </button>
                    </div>
                    <div class="diseases-grid" id="diseasesGrid">
                        <!-- Diseases will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Prevention Tab -->
            <div id="prevention-tab" class="tab-content">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-shield-alt"></i> Prevention Guide</h2>
                    <div class="action-buttons">
                        <button class="btn" onclick="loadPreventionGuide()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                        <button class="btn btn-secondary" onclick="showSeasonalGuide()">
                            <i class="fas fa-calendar-alt"></i> Seasonal Guide
                        </button>
                        <button class="btn btn-info" onclick="showGeneralPrevention()">
                            <i class="fas fa-lightbulb"></i> General Tips
                        </button>
                    </div>
                    <div id="preventionContent">
                        <div class="loading">
                            <i class="fas fa-seedling" style="font-size: 3rem; color: #4CAF50; margin-bottom: 20px;"></i>
                            <h3>Loading Prevention Guide...</h3>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-file-medical"></i> Generate Reports</h2>
                    <div class="action-buttons">
                        <button class="btn" onclick="generateCurrentReport()">
                            <i class="fas fa-file-medical"></i> Current Report
                        </button>
                        <button class="btn btn-secondary" onclick="generateAllReports()">
                            <i class="fas fa-folder"></i> All Reports
                        </button>
                        <button class="btn btn-warning" onclick="printReport()">
                            <i class="fas fa-print"></i> Print
                        </button>
                        <button class="btn btn-info" onclick="showReportHelp()">
                            <i class="fas fa-question-circle"></i> Help
                        </button>
                    </div>
                    
                    <div class="report-content" id="reportContent">
                        <p style="text-align: center; color: #666; padding: 40px;">
                            Generate a report from current detection or history
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Statistics Tab -->
            <div id="stats-tab" class="tab-content">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-chart-bar"></i> System Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statTotalDetections">0</div>
                            <div class="stat-label">Total Detections</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statUniqueDiseases">0</div>
                            <div class="stat-label">Unique Diseases</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statAvgConfidence">0%</div>
                            <div class="stat-label">Avg. Confidence</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statCameraSupport">Yes</div>
                            <div class="stat-label">Camera Support</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px;"><i class="fas fa-info-circle"></i> System Information</h3>
                        <div class="info-box" style="background: #E8F5E9; color: #333; border: 1px solid #C8E6C9;">
                            <p><strong>Version:</strong> Apple Leaf Disease Detection v3.2</p>
                            <p><strong>Model Accuracy:</strong> 97.7%</p>
                            <p><strong>Detectable Diseases:</strong> <span id="statTotalDiseases">9</span></p>
                            <p><strong>Last Updated:</strong> <span id="lastUpdated"></span></p>
                            <p><strong>API Status:</strong> <span id="apiStatus" style="color: #4CAF50;">Connected</span></p>
                            <p><strong>Storage:</strong> Local Storage (5MB)</p>
                            <p><strong>Model Status:</strong> <span id="modelStatus">Ready</span></p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px;"><i class="fas fa-chart-pie"></i> Additional Statistics</h3>
                        <div class="action-buttons">
                            <button class="btn" onclick="updateStatistics()">
                                <i class="fas fa-sync"></i> Update Stats
                            </button>
                            <button class="btn btn-secondary" onclick="showDetailedStats()">
                                <i class="fas fa-chart-line"></i> Detailed Stats
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <div class="footer-content">
                <div>
                    <h3 style="margin-bottom: 10px; color: white;">Apple Leaf Disease Detection System v3.2</h3>
                    <p style="color: #E0E0E0;">AI-powered diagnosis with comprehensive treatment recommendations</p>
                </div>
                <div class="footer-stats">
                    <div class="stat-item" style="background: rgba(255,255,255,0.1);">
                        <div class="stat-value">9</div>
                        <div class="stat-label">Diseases</div>
                    </div>
                    <div class="stat-item" style="background: rgba(255,255,255,0.1);">
                        <div class="stat-value">97.7%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-item" style="background: rgba(255,255,255,0.1);">
                        <div class="stat-value">24/7</div>
                        <div class="stat-label">Available</div>
                    </div>
                </div>
            </div>
            <p style="margin-top: 20px; font-size: 0.9rem; color: #BDBDBD;">
                <i class="fas fa-lightbulb"></i> For best results, use clear images of apple leaves
            </p>
        </footer>
    </div>

    <script>
        // State management
        let state = {
            selectedImage: null,
            cameraStream: null,
            currentFacingMode: 'environment',
            detectionHistory: JSON.parse(localStorage.getItem('appleDetectionHistory') || '[]'),
            currentDetection: null,
            diseasesData: null,
            cameraActive: false,
            capturedImage: null,
            currentTab: 'detection'
        };
        
        // DOM elements
        const elements = {
            uploadZone: document.getElementById('uploadZone'),
            fileInput: document.getElementById('fileInput'),
            imagePreview: document.getElementById('imagePreview'),
            previewContainer: document.getElementById('previewContainer'),
            detectBtn: document.getElementById('detectBtn'),
            resultsContent: document.getElementById('resultsContent'),
            cameraPreview: document.getElementById('cameraPreview'),
            capturePreview: document.getElementById('capturePreview'),
            capturePreviewContainer: document.getElementById('capturePreviewContainer'),
            historyList: document.getElementById('historyList'),
            diseasesGrid: document.getElementById('diseasesGrid'),
            preventionContent: document.getElementById('preventionContent'),
            reportContent: document.getElementById('reportContent'),
            notifications: document.getElementById('notifications'),
            diseaseModal: document.getElementById('diseaseModal'),
            modalContent: document.getElementById('modalContent')
        };
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üçé Apple Leaf Disease Detection v3.2 Initialized');
            
            // Check API connection
            checkAPIStatus();
            
            // Load initial data
            loadDiseasesFromAPI();
            loadHistory();
            updateStatistics();
            updateUIStats();
            
            // Set current date
            document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString();
            
            // Setup event listeners
            setupDragAndDrop();
            setupCameraControls();
            
            // Check camera support
            checkCameraSupport();
            
            // Setup auto-save
            setInterval(saveState, 30000); // Auto-save every 30 seconds
            
            // Show welcome notification
            showNotification('System initialized successfully!', 'success');
            
            // Initialize model status
            updateModelStatus();
        });
        
        // Tab management
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to clicked tab
            const activeTab = document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // Update current tab
            state.currentTab = tabName;
            
            // Handle tab-specific actions
            switch(tabName) {
                case 'camera':
                    if (!state.cameraActive) {
                        showNotification('Start camera to capture photos', 'info');
                    }
                    break;
                case 'prevention':
                    loadPreventionGuide();
                    break;
                case 'diseases':
                    if (!state.diseasesData) {
                        loadDiseasesFromAPI();
                    } else {
                        renderDiseasesGrid();
                    }
                    break;
                case 'stats':
                    updateStatistics();
                    break;
                case 'reports':
                    // Nothing to do here
                    break;
            }
            
            // Stop camera if leaving camera tab
            if (tabName !== 'camera' && state.cameraStream) {
                stopCamera();
            }
        }
        
        // Drag and drop setup
        function setupDragAndDrop() {
            elements.uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.uploadZone.classList.add('drag-over');
            });
            
            elements.uploadZone.addEventListener('dragleave', () => {
                elements.uploadZone.classList.remove('drag-over');
            });
            
            elements.uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.uploadZone.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
            
            elements.uploadZone.addEventListener('click', () => {
                elements.fileInput.click();
            });
            
            elements.fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }
        
        // File handling
        function handleFile(file) {
            if (!file.type.match('image.*')) {
                showNotification('Please upload a valid image file (JPG, PNG, WEBP only)', 'error');
                return;
            }
            
            if (file.size > 16 * 1024 * 1024) {
                showNotification('File size must be less than 16MB', 'error');
                return;
            }
            
            state.selectedImage = file;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                elements.imagePreview.src = e.target.result;
                elements.previewContainer.classList.remove('hidden');
                showNotification('Image loaded successfully!', 'success');
            };
            reader.readAsDataURL(file);
        }
        
        // Camera functions
        function setupCameraControls() {
            // Event listeners are already set in HTML
            console.log('Camera controls initialized');
        }
        
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: state.currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                state.cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                elements.cameraPreview.srcObject = state.cameraStream;
                elements.cameraPreview.style.display = 'block';
                state.cameraActive = true;
                
                // Update button states
                updateCameraButtons(true);
                
                showNotification('Camera started successfully', 'success');
            } catch (error) {
                console.error('Camera error:', error);
                showNotification('Could not access camera. Please check permissions.', 'error');
            }
        }
        
        function stopCamera() {
            if (state.cameraStream) {
                state.cameraStream.getTracks().forEach(track => track.stop());
                state.cameraStream = null;
            }
            
            elements.cameraPreview.srcObject = null;
            elements.cameraPreview.style.display = 'none';
            state.cameraActive = false;
            
            // Hide capture preview
            elements.capturePreviewContainer.classList.add('hidden');
            
            // Update button states
            updateCameraButtons(false);
            
            showNotification('Camera stopped', 'info');
        }
        
        function switchCamera() {
            state.currentFacingMode = state.currentFacingMode === 'environment' ? 'user' : 'environment';
            stopCamera();
            startCamera();
        }
        
        function capturePhoto() {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = elements.cameraPreview.videoWidth;
            canvas.height = elements.cameraPreview.videoHeight;
            context.drawImage(elements.cameraPreview, 0, 0, canvas.width, canvas.height);
            
            elements.capturePreview.src = canvas.toDataURL('image/jpeg');
            elements.capturePreviewContainer.classList.remove('hidden');
            
            // Store captured image
            canvas.toBlob(function(blob) {
                state.capturedImage = new File([blob], `camera_${Date.now()}.jpg`, { type: 'image/jpeg' });
            }, 'image/jpeg');
            
            showNotification('Photo captured successfully', 'success');
        }
        
        function useCapturedPhoto() {
            if (state.capturedImage) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    elements.imagePreview.src = e.target.result;
                    elements.previewContainer.classList.remove('hidden');
                    state.selectedImage = state.capturedImage;
                };
                reader.readAsDataURL(state.capturedImage);
                
                stopCamera();
                switchTab('detection');
                showNotification('Photo loaded for detection', 'success');
            }
        }
        
        function retakePhoto() {
            elements.capturePreviewContainer.classList.add('hidden');
            showNotification('Ready to capture again', 'info');
        }
        
        function updateCameraButtons(active) {
            document.getElementById('startCameraBtn').disabled = active;
            document.getElementById('captureBtn').disabled = !active;
            document.getElementById('switchCameraBtn').disabled = !active;
            document.getElementById('stopCameraBtn').disabled = !active;
        }
        
        // Disease detection
        async function detectDisease() {
            if (!state.selectedImage) {
                showNotification('Please select an image first', 'error');
                return;
            }
            
            // Update UI
            elements.detectBtn.disabled = true;
            elements.detectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            elements.resultsContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>Analyzing Image...</h3>
                    <p>Detecting disease patterns and preparing recommendations</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 30%"></div>
                    </div>
                </div>
            `;
            
            try {
                // Create form data
                const formData = new FormData();
                formData.append('image', state.selectedImage);
                
                // Show progress
                updateProgress(60);
                
                // Send to API
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                updateProgress(90);
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    // Create detection record
                    state.currentDetection = {
                        id: Date.now(),
                        disease: data.prediction.disease,
                        confidence: data.prediction.confidence,
                        severity: data.prediction.severity,
                        timestamp: new Date().toISOString(),
                        imageName: state.selectedImage.name,
                        treatment: data.treatment,
                        prediction: data.prediction,
                        fullData: data
                    };
                    
                    // Save to history
                    saveToHistory(state.currentDetection);
                    
                    // Display results
                    updateProgress(100);
                    setTimeout(() => {
                        displayResults(state.currentDetection);
                        showNotification('Disease detected successfully!', 'success');
                    }, 500);
                    
                } else {
                    throw new Error(data.error || 'Unknown error from API');
                }
                
            } catch (error) {
                console.error('Detection error:', error);
                showNotification('Error connecting to API. Using simulated detection.', 'warning');
                simulateDetection();
            } finally {
                elements.detectBtn.disabled = false;
                elements.detectBtn.innerHTML = '<i class="fas fa-search"></i> Detect Disease';
            }
        }
        
        function updateProgress(percent) {
            const progressFill = document.querySelector('.progress-fill');
            if (progressFill) {
                progressFill.style.width = `${percent}%`;
            }
        }
        
        function simulateDetection() {
            const diseases = ['Alternaria leaf spot', 'Brown spot', 'Frogeye leaf spot', 'Grey spot', 'Health', 'Mosaic', 'Powdery mildew', 'Rust', 'Scab'];
            const randomDisease = diseases[Math.floor(Math.random() * diseases.length)];
            const confidence = Math.floor(Math.random() * 30) + 70;
            const severity = confidence >= 85 ? 'high' : confidence >= 70 ? 'medium' : 'low';
            
            state.currentDetection = {
                id: Date.now(),
                disease: randomDisease,
                confidence: confidence,
                severity: severity,
                timestamp: new Date().toISOString(),
                imageName: state.selectedImage.name,
                treatment: {
                    description: `Simulated result for ${randomDisease}. This is a demonstration.`,
                    chemical_treatments: ['General fungicide application'],
                    organic_treatments: ['Neem oil spray', 'Baking soda solution'],
                    cultural_practices: ['Remove infected leaves', 'Improve air circulation'],
                    preventive_measures: ['Regular monitoring', 'Proper sanitation']
                }
            };
            
            saveToHistory(state.currentDetection);
            displayResults(state.currentDetection);
        }
        
        // Results display
        function displayResults(detection) {
            const severityClass = `severity-${detection.severity}`;
            const isHealthy = detection.disease === 'Health';
            
            let html = `
                <div class="disease-card">
                    <div class="disease-name">
                        <i class="${isHealthy ? 'fas fa-heart' : 'fas fa-disease'}"></i> 
                        ${detection.disease}
                        <span class="severity-badge ${severityClass}">
                            ${detection.severity.toUpperCase()}
                        </span>
                    </div>
                    
                    <div class="confidence-meter">
                        <div class="confidence-fill" style="width: ${Math.min(detection.confidence, 100)}%"></div>
                    </div>
                    
                    <div class="confidence-text" style="display: flex; justify-content: space-between; margin: 10px 0;">
                        <span><i class="fas fa-chart-line"></i> Detection Confidence</span>
                        <span style="font-weight: bold; font-size: 1.2rem;">${detection.confidence.toFixed(1)}%</span>
                    </div>
                    
                    <div class="info-box">
                        <p><i class="fas fa-info-circle"></i> ${detection.treatment.description}</p>
                    </div>
                    
                    <div class="treatment-tabs">
                        <div class="treatment-tab active" onclick="switchTreatmentTab('cure', this)">
                            <i class="fas fa-stethoscope"></i> Cure & Treatment
                        </div>
                        <div class="treatment-tab" onclick="switchTreatmentTab('prevention', this)">
                            <i class="fas fa-shield-alt"></i> Prevention
                        </div>
                        <div class="treatment-tab" onclick="switchTreatmentTab('details', this)">
                            <i class="fas fa-info-circle"></i> Details
                        </div>
                    </div>
                    
                    <div id="cure-content" class="treatment-content active">
                        ${detection.treatment.chemical_treatments ? `
                            <div class="section-title">
                                <i class="fas fa-pills"></i> Chemical Treatments:
                            </div>
                            ${detection.treatment.chemical_treatments.map(t => 
                                `<div class="treatment-item">${t}</div>`
                            ).join('')}
                        ` : ''}
                        
                        ${detection.treatment.organic_treatments ? `
                            <div class="section-title" style="margin-top: 15px;">
                                <i class="fas fa-leaf"></i> Organic Treatments:
                            </div>
                            ${detection.treatment.organic_treatments.map(t => 
                                `<div class="treatment-item">${t}</div>`
                            ).join('')}
                        ` : ''}
                    </div>
                    
                    <div id="prevention-content" class="treatment-content">
                        ${detection.treatment.preventive_measures ? `
                            <div class="section-title">
                                <i class="fas fa-clipboard-check"></i> Preventive Measures:
                            </div>
                            ${detection.treatment.preventive_measures.map(m => 
                                `<div class="treatment-item">${m}</div>`
                            ).join('')}
                        ` : ''}
                        
                        ${detection.treatment.cultural_practices ? `
                            <div class="section-title" style="margin-top: 15px;">
                                <i class="fas fa-tractor"></i> Cultural Practices:
                            </div>
                            ${detection.treatment.cultural_practices.map(p => 
                                `<div class="treatment-item">${p}</div>`
                            ).join('')}
                        ` : ''}
                    </div>
                    
                    <div id="details-content" class="treatment-content">
                        <div class="section-title">
                            <i class="fas fa-calendar-alt"></i> Detection Information:
                        </div>
                        <div class="treatment-item">Date: ${new Date(detection.timestamp).toLocaleDateString()}</div>
                        <div class="treatment-item">Time: ${new Date(detection.timestamp).toLocaleTimeString()}</div>
                        <div class="treatment-item">Image: ${detection.imageName}</div>
                        <div class="treatment-item">Confidence: ${detection.confidence.toFixed(1)}%</div>
                        <div class="treatment-item">Severity: ${detection.severity.toUpperCase()}</div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn" onclick="downloadReport('${detection.disease}')">
                            <i class="fas fa-download"></i> Download Report
                        </button>
                        <button class="btn btn-secondary" onclick="saveDetection()">
                            <i class="fas fa-save"></i> Save Detection
                        </button>
                        <button class="btn btn-info" onclick="showDiseaseDetailsModal('${detection.disease}')">
                            <i class="fas fa-info-circle"></i> More Info
                        </button>
                    </div>
                </div>
            `;
            
            elements.resultsContent.innerHTML = html;
        }
        
        function switchTreatmentTab(tabName, element) {
            // Update tabs
            document.querySelectorAll('.treatment-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            
            // Update content
            document.querySelectorAll('.treatment-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-content`).classList.add('active');
        }
        
        // History management
        function saveToHistory(detection) {
            state.detectionHistory.unshift(detection);
            if (state.detectionHistory.length > 100) {
                state.detectionHistory = state.detectionHistory.slice(0, 100);
            }
            
            localStorage.setItem('appleDetectionHistory', JSON.stringify(state.detectionHistory));
            updateStatistics();
            loadHistory();
        }
        
        function loadHistory() {
            if (state.detectionHistory.length === 0) {
                elements.historyList.innerHTML = `
                    <p style="text-align: center; padding: 40px; color: #666;">
                        No detection history yet. Upload an image to get started!
                    </p>
                `;
                return;
            }
            
            let html = '';
            state.detectionHistory.forEach((item, index) => {
                const date = new Date(item.timestamp);
                const severityClass = `severity-${item.severity}`;
                
                html += `
                    <div class="history-item" onclick="viewHistoryItem(${index})">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="${item.disease === 'Health' ? 'fas fa-heart' : 'fas fa-disease'}" 
                                   style="color: ${item.disease === 'Health' ? '#4CAF50' : '#f44336'}"></i>
                                <strong>${item.disease}</strong>
                            </div>
                            <div style="font-weight: bold; color: #4CAF50; font-size: 1.1rem;">
                                ${item.confidence.toFixed(1)}%
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9rem;">
                            <span class="severity-badge ${severityClass}" style="padding: 3px 10px;">
                                ${item.severity.toUpperCase()}
                            </span>
                            <span style="color: #666;">
                                ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            elements.historyList.innerHTML = html;
        }
        
        function viewHistoryItem(index) {
            const item = state.detectionHistory[index];
            if (item) {
                state.currentDetection = item;
                displayResults(item);
                switchTab('detection');
                showNotification('Loaded from history', 'info');
            }
        }
        
        function clearHistory() {
            if (state.detectionHistory.length === 0) {
                showNotification('No history to clear', 'info');
                return;
            }
            
            if (confirm('Are you sure you want to clear all detection history? This action cannot be undone.')) {
                state.detectionHistory = [];
                localStorage.removeItem('appleDetectionHistory');
                loadHistory();
                updateStatistics();
                showNotification('History cleared successfully', 'success');
            }
        }
        
        // Diseases database
        async function loadDiseasesFromAPI() {
            try {
                showNotification('Loading diseases database...', 'info');
                const response = await fetch('/api/diseases');
                const data = await response.json();
                
                if (data.status === 'success') {
                    state.diseasesData = data.diseases;
                    renderDiseasesGrid();
                    showNotification('Diseases loaded successfully', 'success');
                }
            } catch (error) {
                console.error('Error loading diseases:', error);
                // Fallback to static data
                state.diseasesData = {
                    'Alternaria leaf spot': { 
                        type: 'fungal', 
                        description: 'Dark brown to black spots with concentric rings on leaves and fruit',
                        symptoms: ['Dark brown to black circular spots', 'Concentric rings within spots', 'Yellow halos around spots'],
                        prevention: ['Remove infected leaves', 'Improve air circulation', 'Avoid overhead watering'],
                        severity: 'medium'
                    },
                    'Brown spot': { 
                        type: 'fungal', 
                        description: 'Circular brown spots with yellow halos on leaves',
                        symptoms: ['Circular brown spots', 'Yellow halos around spots', 'Premature leaf drop'],
                        prevention: ['Use resistant varieties', 'Proper spacing between plants', 'Regular fungicide application'],
                        severity: 'medium'
                    },
                    'Frogeye leaf spot': { 
                        type: 'fungal', 
                        description: 'Frog-eye shaped spots on leaves and cankers on branches',
                        symptoms: ['Small gray spots with purple margins', 'Spots enlarge to form "frog-eye" pattern', 'Cankers on branches'],
                        prevention: ['Prune infected branches', 'Apply fungicides during growing season', 'Remove fallen leaves'],
                        severity: 'high'
                    },
                    'Grey spot': { 
                        type: 'fungal', 
                        description: 'Grayish spots with purple margins on leaves',
                        symptoms: ['Grayish circular spots', 'Purple or brown margins', 'Spots may coalesce'],
                        prevention: ['Avoid dense planting', 'Use preventative fungicides', 'Remove infected plant material'],
                        severity: 'low'
                    },
                    'Health': { 
                        type: 'healthy', 
                        description: 'Healthy apple leaf with no disease symptoms',
                        symptoms: ['Vibrant green color', 'Normal leaf shape', 'No spots or discoloration'],
                        prevention: ['Regular monitoring', 'Proper fertilization', 'Adequate watering'],
                        severity: 'none'
                    },
                    'Mosaic': { 
                        type: 'viral', 
                        description: 'Yellow mosaic patterns on leaves, stunted growth',
                        symptoms: ['Yellow mosaic patterns', 'Leaf distortion', 'Stunted plant growth'],
                        prevention: ['Use virus-free planting material', 'Control aphid vectors', 'Remove infected plants'],
                        severity: 'high'
                    },
                    'Powdery mildew': { 
                        type: 'fungal', 
                        description: 'White powdery growth on leaves, shoots, and sometimes fruit',
                        symptoms: ['White powdery coating', 'Leaf curling', 'Reduced photosynthesis'],
                        prevention: ['Plant in sunny locations', 'Improve air circulation', 'Use resistant varieties'],
                        severity: 'medium'
                    },
                    'Rust': { 
                        type: 'fungal', 
                        description: 'Orange or yellow rust pustules on leaves, often with alternate hosts',
                        symptoms: ['Orange or yellow pustules', 'Leaf yellowing', 'Premature defoliation'],
                        prevention: ['Remove alternate hosts', 'Apply fungicides', 'Space plants properly'],
                        severity: 'high'
                    },
                    'Scab': { 
                        type: 'fungal', 
                        description: 'Olive-green to black spots on leaves and fruit, corky lesions',
                        symptoms: ['Olive-green spots', 'Corky lesions on fruit', 'Leaf distortion'],
                        prevention: ['Remove fallen leaves', 'Apply fungicides in spring', 'Use resistant cultivars'],
                        severity: 'high'
                    }
                };
                renderDiseasesGrid();
                showNotification('Loaded diseases from cache', 'info');
            }
        }
        
        function renderDiseasesGrid() {
            if (!state.diseasesData) return;
            
            let html = '';
            for (const [diseaseName, diseaseInfo] of Object.entries(state.diseasesData)) {
                const isHealthy = diseaseName === 'Health';
                const icon = isHealthy ? 'fas fa-heart' : 'fas fa-bug';
                const color = isHealthy ? '#4CAF50' : diseaseInfo.type === 'viral' ? '#9C27B0' : diseaseInfo.type === 'fungal' ? '#F57C00' : '#2196F3';
                const severityClass = diseaseInfo.severity ? `severity-${diseaseInfo.severity}` : '';
                
                html += `
                    <div class="disease-item" onclick="showDiseaseDetailsModal('${diseaseName}')">
                        <div class="disease-icon" style="color: ${color};">
                            <i class="${icon}"></i>
                        </div>
                        <h3 style="color: ${color};">${diseaseName}</h3>
                        <p style="font-size: 0.9rem; color: #666; margin-top: 10px; min-height: 60px;">
                            ${diseaseInfo.description || 'No description available'}
                        </p>
                        <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.8rem; background: ${color}20; 
                                   color: ${color}; padding: 3px 10px; border-radius: 15px;">
                                ${diseaseInfo.type || 'Unknown'}
                            </span>
                            ${diseaseInfo.severity ? `
                                <span class="severity-badge ${severityClass}" style="font-size: 0.7rem; padding: 2px 8px;">
                                    ${diseaseInfo.severity.toUpperCase()}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            elements.diseasesGrid.innerHTML = html;
        }
        
        function showAllDiseases() {
            renderDiseasesGrid();
            showNotification('Showing all diseases', 'info');
        }
        
        function showHealthyInfo() {
            showDiseaseDetailsModal('Health');
        }
        
        // Disease details modal
        function showDiseaseDetailsModal(diseaseName) {
            const diseaseInfo = state.diseasesData ? state.diseasesData[diseaseName] : null;
            if (!diseaseInfo) {
                showNotification('Disease information not available', 'error');
                return;
            }
            
            const isHealthy = diseaseName === 'Health';
            const icon = isHealthy ? 'fas fa-heart' : 'fas fa-disease';
            const color = isHealthy ? '#4CAF50' : diseaseInfo.type === 'viral' ? '#9C27B0' : diseaseInfo.type === 'fungal' ? '#F57C00' : '#2196F3';
            const severityClass = diseaseInfo.severity ? `severity-${diseaseInfo.severity}` : '';
            
            let modalHtml = `
                <h2 style="color: ${color}; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="${icon}"></i> ${diseaseName}
                    ${diseaseInfo.severity ? `
                        <span class="severity-badge ${severityClass}" style="font-size: 0.8rem; padding: 4px 12px;">
                            ${diseaseInfo.severity.toUpperCase()}
                        </span>
                    ` : ''}
                </h2>
                
                <div style="background: #F5F5F5; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid ${color};">
                    <p><strong>Type:</strong> ${diseaseInfo.type || 'Unknown'}</p>
                    <p><strong>Description:</strong> ${diseaseInfo.description || 'No description available'}</p>
                </div>
                
                ${diseaseInfo.symptoms ? `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: ${color}; margin-bottom: 10px;">
                            <i class="fas fa-exclamation-triangle"></i> Symptoms
                        </h4>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #E0E0E0;">
                            ${diseaseInfo.symptoms.map(s => `<div style="margin-bottom: 8px; padding-left: 15px; position: relative;">
                                <span style="position: absolute; left: 0; color: ${color};">‚Ä¢</span>
                                ${s}
                            </div>`).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${diseaseInfo.prevention ? `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: ${color}; margin-bottom: 10px;">
                            <i class="fas fa-shield-alt"></i> Prevention
                        </h4>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #E0E0E0;">
                            ${diseaseInfo.prevention.map(p => `<div style="margin-bottom: 8px; padding-left: 15px; position: relative;">
                                <span style="position: absolute; left: 0; color: ${color};">‚Ä¢</span>
                                ${p}
                            </div>`).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div class="action-buttons" style="margin-top: 20px;">
                    <button class="btn" onclick="testThisDisease('${diseaseName}')" style="flex: 1;">
                        <i class="fas fa-search"></i> Test This Disease
                    </button>
                    <button class="btn btn-secondary" onclick="downloadTreatmentInfo('${diseaseName}')" style="flex: 1;">
                        <i class="fas fa-download"></i> Download Info
                    </button>
                </div>
            `;
            
            elements.modalContent.innerHTML = modalHtml;
            elements.diseaseModal.classList.add('active');
        }
        
        function closeModal() {
            elements.diseaseModal.classList.remove('active');
        }
        
        function testThisDisease(diseaseName) {
            closeModal();
            showNotification(`Testing for ${diseaseName} - please upload an image`, 'info');
            switchTab('detection');
        }
        
        // Prevention guide
        async function loadPreventionGuide() {
            try {
                showNotification('Loading prevention guide...', 'info');
                
                // Simulate API call
                const guide = {
                    general_prevention: [
                        'Regularly inspect plants for early signs of disease',
                        'Maintain proper spacing between plants for air circulation',
                        'Avoid overhead watering to reduce leaf wetness',
                        'Use disease-resistant varieties when available',
                        'Practice crop rotation in orchards',
                        'Keep the area clean of fallen leaves and debris',
                        'Sanitize pruning tools between uses',
                        'Apply preventive fungicides during high-risk periods',
                        'Monitor weather conditions for disease-favorable environments',
                        'Maintain proper soil pH and nutrition'
                    ],
                    seasonal_schedule: {
                        'spring': [
                            'Apply dormant oil sprays before bud break',
                            'Remove and destroy overwintering infected material',
                            'Begin regular fungicide applications if needed',
                            'Monitor for early disease symptoms',
                            'Prune trees for better air circulation'
                        ],
                        'summer': [
                            'Continue regular monitoring',
                            'Apply fungicides according to schedule',
                            'Remove infected leaves promptly',
                            'Maintain proper irrigation',
                            'Control insect vectors'
                        ],
                        'fall': [
                            'Clean up fallen leaves and fruit',
                            'Apply final fungicide applications',
                            'Prepare plants for winter',
                            'Record disease occurrences for next year',
                            'Apply urea to fallen leaves to speed decomposition'
                        ],
                        'winter': [
                            'Prune dormant trees',
                            'Apply dormant sprays',
                            'Plan for next season',
                            'Review and order disease-resistant varieties',
                            'Repair and maintain equipment'
                        ]
                    },
                    disease_specific: {
                        'Alternaria leaf spot': {
                            key_prevention: [
                                'Remove infected plant material',
                                'Improve air circulation',
                                'Use preventative fungicides',
                                'Avoid overhead watering',
                                'Use resistant varieties when available'
                            ]
                        },
                        'Brown spot': {
                            key_prevention: [
                                'Plant resistant varieties',
                                'Space plants properly',
                                'Apply fungicides early',
                                'Remove fallen leaves',
                                'Maintain tree vigor'
                            ]
                        },
                        'Frogeye leaf spot': {
                            key_prevention: [
                                'Prune infected branches',
                                'Apply fungicides during growing season',
                                'Remove fallen leaves',
                                'Improve tree health',
                                'Remove wild apple trees nearby'
                            ]
                        },
                        'Grey spot': {
                            key_prevention: [
                                'Avoid dense planting',
                                'Use preventative fungicides',
                                'Remove infected leaves',
                                'Maintain plant vigor',
                                'Improve air circulation'
                            ]
                        },
                        'Powdery mildew': {
                            key_prevention: [
                                'Plant in sunny locations',
                                'Improve air circulation',
                                'Use resistant varieties',
                                'Apply sulfur-based fungicides',
                                'Avoid excessive nitrogen fertilization'
                            ]
                        },
                        'Rust': {
                            key_prevention: [
                                'Remove alternate hosts',
                                'Apply fungicides',
                                'Space plants properly',
                                'Use resistant cultivars',
                                'Monitor for early symptoms'
                            ]
                        },
                        'Scab': {
                            key_prevention: [
                                'Remove fallen leaves',
                                'Apply fungicides in spring',
                                'Use resistant cultivars',
                                'Prune for air circulation',
                                'Monitor leaf wetness periods'
                            ]
                        }
                    }
                };
                
                let html = `
                    <div style="margin-bottom: 25px;">
                        <h3 style="margin-bottom: 15px; color: var(--primary-dark);">
                            <i class="fas fa-lightbulb"></i> General Prevention Tips
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                            ${guide.general_prevention.map((item, index) => `
                                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <div style="display: flex; align-items: start; gap: 10px;">
                                        <span style="background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; flex-shrink: 0;">
                                            ${index + 1}
                                        </span>
                                        <div>${item}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="margin-bottom: 15px; color: var(--primary-dark);">
                            <i class="fas fa-calendar-alt"></i> Seasonal Management
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                `;
                
                for (const [season, tips] of Object.entries(guide.seasonal_schedule)) {
                    const seasonColors = {
                        'spring': '#4CAF50',
                        'summer': '#FF9800',
                        'fall': '#795548',
                        'winter': '#2196F3'
                    };
                    
                    html += `
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid ${seasonColors[season]}; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                            <h4 style="color: ${seasonColors[season]}; margin-bottom: 10px; text-transform: capitalize;">
                                <i class="fas fa-${season === 'spring' ? 'seedling' : season === 'summer' ? 'sun' : season === 'fall' ? 'leaf' : 'snowflake'}"></i> ${season}
                            </h4>
                            ${tips.map(tip => `
                                <div style="margin-bottom: 8px; padding-left: 15px; position: relative;">
                                    <span style="position: absolute; left: 0; color: ${seasonColors[season]};">‚Ä¢</span>
                                    ${tip}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="margin-bottom: 15px; color: var(--primary-dark);">
                            <i class="fas fa-bug"></i> Disease-Specific Prevention
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                `;
                
                for (const [disease, info] of Object.entries(guide.disease_specific)) {
                    const diseaseColor = disease === 'Health' ? '#4CAF50' : '#f44336';
                    
                    html += `
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #E0E0E0; 
                             box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                            <h4 style="color: ${diseaseColor}; margin-bottom: 10px;">${disease}</h4>
                            <div style="font-size: 0.9rem; color: #666;">
                                ${info.key_prevention.map(item => `
                                    <div style="margin-bottom: 8px; padding-left: 15px; position: relative;">
                                        <span style="position: absolute; left: 0; color: ${diseaseColor};">‚Ä¢</span>
                                        ${item}
                                    </div>
                                `).join('')}
                            </div>
                            <button class="btn" style="margin-top: 15px; width: 100%; background: ${diseaseColor};" 
                                    onclick="showDiseaseDetailsModal('${disease}')">
                                <i class="fas fa-info-circle"></i> View Full Guide
                            </button>
                        </div>
                    `;
                }
                
                html += '</div>';
                elements.preventionContent.innerHTML = html;
                
                showNotification('Prevention guide loaded successfully', 'success');
                
            } catch (error) {
                console.error('Error loading prevention guide:', error);
                elements.preventionContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ff9800; margin-bottom: 20px;"></i>
                        <h3>Error Loading Prevention Guide</h3>
                        <p>Please try again later or check the diseases tab.</p>
                        <button class="btn" onclick="loadPreventionGuide()" style="margin-top: 20px;">
                            <i class="fas fa-sync"></i> Retry
                        </button>
                    </div>
                `;
            }
        }
        
        function showSeasonalGuide() {
            // Focus on seasonal guide section
            const seasonalSection = elements.preventionContent.querySelector('h3:nth-child(2)');
            if (seasonalSection) {
                seasonalSection.scrollIntoView({ behavior: 'smooth' });
            }
            showNotification('Showing seasonal management guide', 'info');
        }
        
        function showGeneralPrevention() {
            // Focus on general prevention section
            const generalSection = elements.preventionContent.querySelector('h3:first-child');
            if (generalSection) {
                generalSection.scrollIntoView({ behavior: 'smooth' });
            }
            showNotification('Showing general prevention tips', 'info');
        }
        
        // Report generation
        async function generateCurrentReport() {
            if (!state.currentDetection) {
                showNotification('No current detection to generate report', 'info');
                return;
            }
            
            try {
                const reportText = `
APPLE LEAF DISEASE DETECTION REPORT
====================================

Detection Information:
----------------------
Disease: ${state.currentDetection.disease}
Confidence: ${state.currentDetection.confidence.toFixed(1)}%
Severity: ${state.currentDetection.severity.toUpperCase()}
Date: ${new Date(state.currentDetection.timestamp).toLocaleDateString()}
Time: ${new Date(state.currentDetection.timestamp).toLocaleTimeString()}
Image: ${state.currentDetection.imageName}

Description:
------------
${state.currentDetection.treatment.description}

Treatment Recommendations:
-------------------------
Chemical Treatments:
${state.currentDetection.treatment.chemical_treatments ? state.currentDetection.treatment.chemical_treatments.map(t => `‚Ä¢ ${t}`).join('\n') : '‚Ä¢ No specific chemical treatments recommended'}

Organic Treatments:
${state.currentDetection.treatment.organic_treatments ? state.currentDetection.treatment.organic_treatments.map(t => `‚Ä¢ ${t}`).join('\n') : '‚Ä¢ No specific organic treatments recommended'}

Preventive Measures:
${state.currentDetection.treatment.preventive_measures ? state.currentDetection.treatment.preventive_measures.map(m => `‚Ä¢ ${m}`).join('\n') : '‚Ä¢ No specific preventive measures'}

Cultural Practices:
${state.currentDetection.treatment.cultural_practices ? state.currentDetection.treatment.cultural_practices.map(p => `‚Ä¢ ${p}`).join('\n') : '‚Ä¢ No specific cultural practices'}

Report Generated: ${new Date().toLocaleString()}
Apple Leaf Disease Detection System v3.2
                `;
                
                elements.reportContent.textContent = reportText;
                switchTab('reports');
                showNotification('Report generated successfully', 'success');
            } catch (error) {
                console.error('Error generating report:', error);
                showNotification('Error generating report', 'error');
            }
        }
        
        function generateAllReports() {
            if (state.detectionHistory.length === 0) {
                showNotification('No history to generate reports', 'info');
                return;
            }
            
            let allReports = 'COMPLETE DETECTION HISTORY REPORT\n';
            allReports += '='.repeat(50) + '\n\n';
            allReports += `Generated: ${new Date().toLocaleString()}\n`;
            allReports += `Total Detections: ${state.detectionHistory.length}\n`;
            allReports += '='.repeat(50) + '\n\n';
            
            state.detectionHistory.forEach((item, index) => {
                allReports += `REPORT ${index + 1}: ${item.disease}\n`;
                allReports += `Date: ${new Date(item.timestamp).toLocaleDateString()}\n`;
                allReports += `Confidence: ${item.confidence.toFixed(1)}%\n`;
                allReports += `Severity: ${item.severity.toUpperCase()}\n`;
                allReports += '-'.repeat(30) + '\n\n';
            });
            
            elements.reportContent.textContent = allReports;
            switchTab('reports');
            showNotification('All reports generated', 'success');
        }
        
        function showReportHelp() {
            showNotification('Generate current report from last detection, or all reports from history', 'info');
        }
        
        function printReport() {
            const reportContent = elements.reportContent.textContent;
            if (!reportContent || reportContent.includes('Generate a report')) {
                showNotification('Please generate a report first', 'info');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Apple Disease Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                        pre { white-space: pre-wrap; font-size: 12px; background: #f8f9fa; padding: 20px; border-radius: 8px; }
                        h1 { color: #4CAF50; text-align: center; margin-bottom: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #4CAF50; padding-bottom: 20px; }
                        .footer { margin-top: 40px; text-align: center; font-size: 10px; color: #666; border-top: 1px solid #ddd; padding-top: 20px; }
                        @media print {
                            body { margin: 20px; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üçé Apple Leaf Disease Report</h1>
                        <p>Generated: ${new Date().toLocaleString()}</p>
                    </div>
                    <pre>${reportContent}</pre>
                    <div class="footer">
                        <p>Apple Leaf Disease Detection System v3.2 | Generated Report</p>
                        <p>This report is for informational purposes only. Always consult with agricultural experts.</p>
                    </div>
                    <button class="no-print" onclick="window.print()" style="position: fixed; top: 20px; right: 20px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Print Report
                    </button>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // Utility functions
        function clearImage() {
            state.selectedImage = null;
            elements.imagePreview.src = '';
            elements.previewContainer.classList.add('hidden');
            elements.resultsContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>Ready for Detection</h3>
                    <p>Upload an image to start analysis</p>
                </div>
            `;
            showNotification('Image cleared', 'info');
        }
        
        function enhanceImage() {
            showNotification('Image enhancement feature coming soon!', 'info');
            // In a real implementation, this would send the image to an enhancement API
        }
        
        function saveDetection() {
            if (state.currentDetection) {
                showNotification('Detection saved to history', 'success');
            } else {
                showNotification('No detection to save', 'warning');
            }
        }
        
        async function downloadReport(diseaseName) {
            try {
                const reportText = `
Treatment Information for: ${diseaseName}

Description:
${state.diseasesData[diseaseName]?.description || 'N/A'}

Recommended Treatments:
‚Ä¢ General fungicide application
‚Ä¢ Neem oil spray (organic option)
‚Ä¢ Remove infected leaves
‚Ä¢ Improve air circulation

Prevention Tips:
‚Ä¢ Regular monitoring of plants
‚Ä¢ Proper sanitation practices
‚Ä¢ Maintain good air circulation
‚Ä¢ Use disease-resistant varieties when available

Downloaded: ${new Date().toLocaleString()}
Apple Leaf Disease Detection System v3.2
                `;
                
                const blob = new Blob([reportText], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `treatment_${diseaseName.replace(/ /g, '_')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                showNotification('Report downloaded successfully', 'success');
            } catch (error) {
                showNotification('Error downloading report', 'error');
            }
        }
        
        async function downloadTreatmentInfo(diseaseName) {
            try {
                const diseaseInfo = state.diseasesData[diseaseName];
                const treatmentInfo = `
Treatment Information for: ${diseaseName}

Description:
${diseaseInfo?.description || 'N/A'}

Symptoms:
${diseaseInfo?.symptoms ? diseaseInfo.symptoms.map(s => `‚Ä¢ ${s}`).join('\n') : '‚Ä¢ No specific symptoms listed'}

Prevention Tips:
${diseaseInfo?.prevention ? diseaseInfo.prevention.map(p => `‚Ä¢ ${p}`).join('\n') : '‚Ä¢ Regular monitoring\n‚Ä¢ Proper sanitation\n‚Ä¢ Adequate spacing'}

Recommended Treatments:
‚Ä¢ General fungicide application
‚Ä¢ Neem oil spray (organic option)
‚Ä¢ Remove infected leaves
‚Ä¢ Improve air circulation

Downloaded: ${new Date().toLocaleString()}
Apple Leaf Disease Detection System v3.2
                `;
                
                const blob = new Blob([treatmentInfo], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `treatment_${diseaseName.replace(/\s+/g, '_')}.txt`;
                link.click();
                window.URL.revokeObjectURL(url);
                showNotification('Treatment information downloaded', 'success');
            } catch (error) {
                console.error('Error downloading treatment info:', error);
                showNotification('Error downloading treatment info', 'error');
            }
        }
        
        function exportHistory() {
            if (state.detectionHistory.length === 0) {
                showNotification('No data to export', 'info');
                return;
            }
            
            const csvContent = "data:text/csv;charset=utf-8," 
                + "ID,Disease,Confidence,Severity,Timestamp,Image\n"
                + state.detectionHistory.map(item => 
                    `${item.id},${item.disease},${item.confidence},"${item.severity}","${item.timestamp}",${item.imageName}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `apple_disease_history_${Date.now()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('History exported as CSV', 'success');
        }
        
        // Statistics
        function updateStatistics() {
            // Update history stats
            document.getElementById('statTotalDetections').textContent = state.detectionHistory.length;
            
            const uniqueDiseases = [...new Set(state.detectionHistory.map(item => item.disease))];
            document.getElementById('statUniqueDiseases').textContent = uniqueDiseases.length;
            
            const avgConfidence = state.detectionHistory.length > 0 
                ? (state.detectionHistory.reduce((sum, item) => sum + item.confidence, 0) / state.detectionHistory.length).toFixed(1)
                : 0;
            document.getElementById('statAvgConfidence').textContent = avgConfidence + '%';
            
            // Update UI stats
            updateUIStats();
            
            showNotification('Statistics updated', 'success');
        }
        
        function updateUIStats() {
            document.getElementById('detections').textContent = state.detectionHistory.length;
            document.getElementById('statTotalDiseases').textContent = state.diseasesData ? Object.keys(state.diseasesData).length : 9;
        }
        
        function checkCameraSupport() {
            const hasCamera = navigator.mediaDevices && navigator.mediaDevices.getUserMedia;
            document.getElementById('statCameraSupport').textContent = hasCamera ? 'Yes' : 'No';
        }
        
        function updateModelStatus() {
            document.getElementById('modelStatus').textContent = 'Ready';
            document.getElementById('modelStatus').style.color = '#4CAF50';
        }
        
        function showDetailedStats() {
            showNotification('Detailed statistics feature coming soon!', 'info');
        }
        
        async function checkAPIStatus() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                if (data.status === 'healthy') {
                    document.getElementById('systemStatus').textContent = 'Online';
                    document.getElementById('systemStatus').style.color = '#4CAF50';
                    document.getElementById('apiStatus').textContent = 'Connected';
                    document.getElementById('apiStatus').style.color = '#4CAF50';
                    return true;
                }
            } catch (error) {
                console.error('API connection error:', error);
                document.getElementById('systemStatus').textContent = 'Offline';
                document.getElementById('systemStatus').style.color = '#f44336';
                document.getElementById('apiStatus').textContent = 'Disconnected';
                document.getElementById('apiStatus').style.color = '#f44336';
                return false;
            }
        }
        
        // Notification system
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${getNotificationIcon(type)}"></i>
                <span>${message}</span>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%"></div>
                </div>
            `;
            
            elements.notifications.appendChild(notification);
            
            // Animate progress bar
            setTimeout(() => {
                const progressFill = notification.querySelector('.progress-fill');
                if (progressFill) {
                    progressFill.style.width = '0%';
                    progressFill.style.transition = `width ${duration}ms linear`;
                }
            }, 100);
            
            // Remove notification after duration
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                notification.style.transition = 'all 0.3s ease';
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }
        
        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }
        
        // State management
        function saveState() {
            try {
                localStorage.setItem('appleDetectionHistory', JSON.stringify(state.detectionHistory));
                // Auto-save every 30 seconds
            } catch (error) {
                console.error('Error saving state:', error);
            }
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (state.cameraStream) {
                state.cameraStream.getTracks().forEach(track => track.stop());
            }
            saveState();
        });
        
        // Close modal on outside click
        window.addEventListener('click', (event) => {
            if (event.target === elements.diseaseModal) {
                closeModal();
            }
        });
        
        // Close modal on ESC key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && elements.diseaseModal.classList.contains('active')) {
                closeModal();
            }
        });
    </script>
</body>
</html>
